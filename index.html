<!DOCTYPE html>
<html>
  <head>
    <base target="_top">
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="https://fonts.googleapis.com/css2?family=DM+Mono:wght@300;400;500&family=Instrument+Serif:ital@0;1&display=swap" rel="stylesheet">
    <style>
      :root {
        --bg: #f5f4f0;
        --surface: #ffffff;
        --surface-hover: #fafaf8;
        --border: #e2e0da;
        --text: #1a1a18;
        --text-muted: #8a8880;
        --accent: #2d6a4f;
        --accent-light: rgba(45, 106, 79, 0.07);
        --accent-border: rgba(45, 106, 79, 0.15);
        --danger: #c0392b;
        --danger-light: rgba(192, 57, 43, 0.06);
        --danger-border: rgba(192, 57, 43, 0.12);
        --radius: 10px;
      }

      * { margin: 0; padding: 0; box-sizing: border-box; }

      body {
        font-family: 'DM Mono', monospace;
        background: var(--bg);
        color: var(--text);
        min-height: 100vh;
        display: flex;
        flex-direction: column;
        align-items: center;
        padding: 80px 24px 40px;
        position: relative;
        overflow-x: hidden;
      }

      /* Subtle dot grid */
      body::before {
        content: '';
        position: fixed;
        inset: 0;
        background-image: radial-gradient(circle, rgba(45, 106, 79, 0.06) 1px, transparent 1px);
        background-size: 32px 32px;
        pointer-events: none;
        z-index: 0;
      }

      .container {
        position: relative;
        z-index: 1;
        width: 100%;
        max-width: 520px;
      }

      /* Header */
      .header {
        margin-bottom: 48px;
      }

      .header h1 {
        font-family: 'Instrument Serif', serif;
        font-weight: 400;
        font-size: 3rem;
        letter-spacing: -0.02em;
        line-height: 1;
        color: var(--text);
      }

      .header h1 span {
        color: var(--accent);
        font-style: italic;
      }

      .header p {
        margin-top: 12px;
        font-size: 0.75rem;
        color: var(--text-muted);
        letter-spacing: 0.06em;
        text-transform: uppercase;
      }

      /* Card */
      .card {
        background: var(--surface);
        border: 1px solid var(--border);
        border-radius: var(--radius);
        padding: 28px;
        animation: fadeUp 0.6s ease both;
        box-shadow: 0 1px 3px rgba(0,0,0,0.04);
      }

      .card + .card {
        margin-top: 16px;
        animation-delay: 0.1s;
      }

      .card-label {
        font-size: 0.65rem;
        text-transform: uppercase;
        letter-spacing: 0.1em;
        color: var(--text-muted);
        margin-bottom: 20px;
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .card-label::before {
        content: '';
        width: 6px;
        height: 6px;
        border-radius: 50%;
        background: var(--accent);
        display: inline-block;
        animation: pulse 2.5s ease-in-out infinite;
      }

      /* Button base */
      .action-btn {
        width: 100%;
        padding: 16px 24px;
        border: none;
        border-radius: calc(var(--radius) - 2px);
        font-family: 'DM Mono', monospace;
        font-size: 0.8rem;
        font-weight: 500;
        letter-spacing: 0.04em;
        cursor: pointer;
        transition: all 0.2s ease;
        position: relative;
        overflow: hidden;
      }

      .action-btn:hover:not(:disabled) {
        transform: translateY(-1px);
      }

      .action-btn:active:not(:disabled) {
        transform: translateY(0);
      }

      .action-btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
      }

      .action-btn.loading {
        color: transparent;
      }

      /* Primary (green) */
      .btn-primary {
        background: var(--accent);
        color: #ffffff;
      }

      .btn-primary:hover:not(:disabled) {
        box-shadow: 0 4px 20px rgba(45, 106, 79, 0.2);
      }

      .btn-primary.loading::after {
        content: '';
        position: absolute;
        top: 50%; left: 50%;
        width: 18px; height: 18px;
        margin: -9px 0 0 -9px;
        border: 2px solid #ffffff;
        border-top-color: transparent;
        border-radius: 50%;
        animation: spin 0.6s linear infinite;
      }

      /* Secondary (outlined) */
      .btn-secondary {
        background: transparent;
        color: var(--text);
        border: 1px solid var(--border);
      }

      .btn-secondary:hover:not(:disabled) {
        background: var(--accent-light);
        border-color: var(--accent-border);
        color: var(--accent);
        box-shadow: 0 4px 20px rgba(45, 106, 79, 0.08);
      }

      .btn-secondary.loading::after {
        content: '';
        position: absolute;
        top: 50%; left: 50%;
        width: 18px; height: 18px;
        margin: -9px 0 0 -9px;
        border: 2px solid var(--text);
        border-top-color: transparent;
        border-radius: 50%;
        animation: spin 0.6s linear infinite;
      }

      /* Status */
      .status {
        margin-top: 20px;
        min-height: 24px;
      }

      .status-msg {
        font-size: 0.72rem;
        padding: 12px 16px;
        border-radius: calc(var(--radius) - 2px);
        animation: fadeUp 0.3s ease both;
        line-height: 1.5;
      }

      .status-msg.success {
        background: var(--accent-light);
        color: var(--accent);
        border: 1px solid var(--accent-border);
      }

      .status-msg.error {
        background: var(--danger-light);
        color: var(--danger);
        border: 1px solid var(--danger-border);
      }

      .status-msg.info {
        background: rgba(138, 136, 128, 0.06);
        color: var(--text-muted);
        border: 1px solid var(--border);
      }

      /* Footer detail */
      .detail {
        margin-top: 32px;
        font-size: 0.6rem;
        color: var(--text-muted);
        letter-spacing: 0.04em;
        opacity: 0.5;
        text-align: center;
      }

      /* Animations */
      @keyframes fadeUp {
        from { opacity: 0; transform: translateY(12px); }
        to   { opacity: 1; transform: translateY(0); }
      }

      @keyframes spin {
        to { transform: rotate(360deg); }
      }

      @keyframes pulse {
        0%, 100% { opacity: 1; }
        50%      { opacity: 0.3; }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="header">
        <h1>Command <span>Center</span></h1>
        <p>Email Intake Automation</p>
      </div>

      <div class="card">
        <div class="card-label">Inbox Scanner</div>
        <button class="action-btn btn-primary" id="scanBtn" onclick="handleScan()">
          Scan for New Emails
        </button>
        <div class="status" id="scanStatus"></div>
      </div>

      <div class="card">
        <div class="card-label">Output Processor</div>
        <button class="action-btn btn-secondary" id="processBtn" onclick="handleProcess()">
          Process JSON to Output
        </button>
        <div class="status" id="processStatus"></div>
      </div>

      <div class="detail">Processes inbox emails received after 2026-02-10</div>
    </div>

    <script>
      const scanBtn = document.getElementById('scanBtn');
      const scanStatus = document.getElementById('scanStatus');
      const processBtn = document.getElementById('processBtn');
      const processStatus = document.getElementById('processStatus');

      /**
       * Sets a button into loading state with a status message.
       * @param {HTMLButtonElement} btn
       * @param {HTMLElement} statusEl
       * @param {string} msg
       */
      function setLoading(btn, statusEl, msg) {
        btn.disabled = true;
        btn.classList.add('loading');
        showStatus(statusEl, msg, 'info');
      }

      /**
       * Clears the loading state from a button.
       * @param {HTMLButtonElement} btn
       */
      function clearLoading(btn) {
        btn.disabled = false;
        btn.classList.remove('loading');
      }

      /**
       * Displays a status message in the given element.
       * @param {HTMLElement} el
       * @param {string} msg
       * @param {string} type - 'success', 'error', or 'info'
       */
      function showStatus(el, msg, type) {
        el.innerHTML = '<div class="status-msg ' + type + '">' + msg + '</div>';
      }

      /* ── Scan ── */

      /**
       * Handles the scan button click.
       */
      function handleScan() {
        setLoading(scanBtn, scanStatus, 'Scanning inbox…');
        google.script.run
          .withSuccessHandler(onScanSuccess)
          .withFailureHandler(onScanFailure)
          .scanForNewEmails();
      }

      /**
       * @param {{newCount: number, totalProcessed: number}} result
       */
      function onScanSuccess(result) {
        clearLoading(scanBtn);
        if (result.newCount === 0) {
          showStatus(scanStatus, 'No new emails found. ' + result.totalProcessed + ' total processed.', 'info');
        } else {
          showStatus(scanStatus, 'Added ' + result.newCount + ' new email(s). ' + result.totalProcessed + ' total processed.', 'success');
        }
      }

      /** @param {Error} err */
      function onScanFailure(err) {
        clearLoading(scanBtn);
        showStatus(scanStatus, 'Error: ' + err.message, 'error');
      }

      /* ── Process ── */

      /**
       * Handles the process button click.
       */
      function handleProcess() {
        setLoading(processBtn, processStatus, 'Processing JSON output…');
        google.script.run
          .withSuccessHandler(onProcessSuccess)
          .withFailureHandler(onProcessFailure)
          .processOutputJson();
      }

      /**
       * @param {{rowsAdded: number, errors: number}} result
       */
      function onProcessSuccess(result) {
        clearLoading(processBtn);
        if (result.rowsAdded === 0 && result.errors === 0) {
          showStatus(processStatus, 'No new JSON data to process.', 'info');
        } else {
          let msg = 'Added ' + result.rowsAdded + ' row(s) to Output.';
          if (result.errors > 0) {
            msg += ' ' + result.errors + ' row(s) had invalid JSON.';
          }
          showStatus(processStatus, msg, result.errors > 0 ? 'error' : 'success');
        }
      }

      /** @param {Error} err */
      function onProcessFailure(err) {
        clearLoading(processBtn);
        showStatus(processStatus, 'Error: ' + err.message, 'error');
      }
    </script>
  </body>
</html>
